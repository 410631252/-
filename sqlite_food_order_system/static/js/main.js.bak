// å…¨å±€è®Šæ•¸
let currentUser = null;
let menuData = {};
let cartItems = [];

// é é¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    await checkAuthStatus();
    await loadMenu();
});

// ç°¡å–®çš„èªè­‰ç›¸é—œå‡½æ•¸
async function checkAuthStatus() {
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    if (userId && userName) {
        currentUser = { user_id: userId, name: userName };
        showAuthenticatedUI();
    }
}

function showAuthenticatedUI() {
    document.getElementById('authPage').classList.remove('active');
    document.getElementById('homePage').classList.add('active');
    document.getElementById('userNav').classList.remove('hidden');
    document.getElementById('welcomeMsg').textContent = `æ­¡è¿ï¼Œ${currentUser.name}`;
}

async function startOrder() {
    const userName = document.getElementById('userName').value.trim();
    
    if (!userName) {
        showToast('è«‹è¼¸å…¥æ‚¨çš„å¤§å');
        return;
    }

    // ç”Ÿæˆä¸€å€‹ç°¡å–®çš„ä½¿ç”¨è€…ID
    const userId = 'user_' + new Date().getTime();
    
    // å„²å­˜ä½¿ç”¨è€…è³‡è¨Š
    currentUser = {
        user_id: userId,
        name: userName
    };

    // å„²å­˜åˆ°æœ¬åœ°å­˜å„²
    localStorage.setItem('userId', userId);
    localStorage.setItem('userName', userName);

    showToast('æ­¡è¿å…‰è‡¨ï¼');
    showAuthenticatedUI();
}

function logout() {
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    currentUser = null;
    cartItems = [];
    location.reload();
}

// é é¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    await checkAuthStatus();
    await loadMenu();
});

// ç°¡å–®çš„èªè­‰ç›¸é—œå‡½æ•¸
async function checkAuthStatus() {
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    if (userId && userName) {
        currentUser = { user_id: userId, name: userName };
        showAuthenticatedUI();
    }
}

function showAuthenticatedUI() {
    document.getElementById('authPage').classList.remove('active');
    document.getElementById('homePage').classList.add('active');
    document.getElementById('userNav').classList.remove('hidden');
    document.getElementById('welcomeMsg').textContent = `æ­¡è¿ï¼Œ${currentUser.name}`;
}

async function startOrder() {
    const userName = document.getElementById('userName').value.trim();
    
    if (!userName) {
        showToast('è«‹è¼¸å…¥æ‚¨çš„å¤§å');
        return;
    }

    // ç”Ÿæˆä¸€å€‹ç°¡å–®çš„ä½¿ç”¨è€…ID
    const userId = 'user_' + new Date().getTime();
    
    // å„²å­˜ä½¿ç”¨è€…è³‡è¨Š
    currentUser = {
        user_id: userId,
        name: userName
    };

    // å„²å­˜åˆ°æœ¬åœ°å­˜å„²
    localStorage.setItem('userId', userId);
    localStorage.setItem('userName', userName);

    showToast('æ­¡è¿å…‰è‡¨ï¼');
    showAuthenticatedUI();
}

function logout() {
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    currentUser = null;
    cartItems = [];
    location.reload();
}
}

// èœå–®ç›¸é—œå‡½æ•¸
async function loadMenu() {
    try {
        const response = await fetch('/api/menu');
        const data = await response.json();
        if (!data.menu) {
            showToast('ç„¡æ³•è¼‰å…¥èœå–®');
            return;
        }
        
        menuData = data.menu;
        
        // æ¸²æŸ“èœå–®åˆ†é¡
        const categories = Object.keys(menuData);
        const categoriesHtml = categories.map(category => 
            `<button class="category-btn" onclick="filterMenu('${category}')">${category}</button>`
        ).join('');
        document.getElementById('menuCategories').innerHTML = categoriesHtml;

        // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹åˆ†é¡
        if (categories.length > 0) {
            filterMenu(categories[0]);
        }
    } catch (error) {
        console.error('è¼‰å…¥èœå–®å¤±æ•—:', error);
        showToast('è¼‰å…¥èœå–®æ™‚ç™¼ç”ŸéŒ¯èª¤');
    }
}

function filterMenu(category) {
    // æ›´æ–°åˆ†é¡æŒ‰éˆ•ç‹€æ…‹
    const buttons = document.querySelectorAll('.category-btn');
    buttons.forEach(btn => {
        btn.classList.toggle('active', btn.textContent === category);
    });

    // æ¸²æŸ“è©²åˆ†é¡çš„èœå“
    const items = menuData[category];
    const menuHtml = items.map(item => `
        <div class="menu-item">
            <div class="menu-item-content">
                <h3>${item.name}</h3>
                <p class="description">${item.description || ''}</p>
                <p class="price">NT$ ${item.price}</p>
            </div>
            <div class="menu-item-actions">
                <button onclick="addToCart(${item.id})" class="add-to-cart-btn">
                    <span class="icon">ğŸ›’</span>
                    åŠ å…¥è³¼ç‰©è»Š
                </button>
            </div>
        </div>
    `).join('');
    
    document.getElementById('menuContainer').innerHTML = menuHtml;
}

// è³¼ç‰©è»Šç›¸é—œå‡½æ•¸
function addToCart(productId) {
    if (!currentUser) {
        showToast('è«‹å…ˆç™»å…¥');
        return;
    }

    let product = null;
    for (const category in menuData) {
        const found = menuData[category].find(item => item.id === productId);
        if (found) {
            product = found;
            break;
        }
    }

    if (!product) return;

    const existingItem = cartItems.find(item => item.product_id === productId);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cartItems.push({
            product_id: productId,
            product_name: product.name,
            price: product.price,
            quantity: 1
        });
    }

    updateCartUI();
    showToast('å·²åŠ å…¥è³¼ç‰©è»Š');
}

function updateCartUI() {
    if (cartItems.length === 0) {
        document.getElementById('cartItems').innerHTML = `
            <div class="empty-cart">
                <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                <p class="hint">è«‹å¾èœå–®ä¸­é¸æ“‡é¤é»</p>
            </div>
        `;
    } else {
        const cartHtml = cartItems.map((item, index) => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <span class="item-name">${item.product_name}</span>
                    <div class="item-controls">
                        <button onclick="updateQuantity(${index}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                        <span class="quantity">${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)">+</button>
                    </div>
                </div>
                <div class="cart-item-price">
                    <span>NT$ ${item.price * item.quantity}</span>
                    <button onclick="removeFromCart(${index})" class="remove-btn">Ã—</button>
                </div>
            </div>
        `).join('');

        document.getElementById('cartItems').innerHTML = cartHtml;
    }
    
    const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
    document.getElementById('total').textContent = `NT$ ${total}`;
    document.getElementById('checkoutBtn').disabled = cartItems.length === 0;
}

function updateQuantity(index, change) {
    const item = cartItems[index];
    const newQuantity = item.quantity + change;
    
    if (newQuantity > 0) {
        item.quantity = newQuantity;
        updateCartUI();
    } else if (newQuantity === 0) {
        removeFromCart(index);
    }
}
}

function removeFromCart(index) {
    cartItems.splice(index, 1);
    updateCartUI();
}

// çµå¸³ç›¸é—œå‡½æ•¸
async function checkout() {
    if (!currentUser) {
        showToast('è«‹å…ˆç™»å…¥');
        return;
    }

    if (cartItems.length === 0) {
        showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
        return;
    }

    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                items: cartItems,
                customer_name: currentUser.name
            })
        });

        const data = await response.json();
        if (response.ok) {
            showToast('è¨‚å–®å·²æˆåŠŸé€å‡ºï¼');
            cartItems = [];
            updateCartUI();
            switchPage('ordersPage');
            await loadOrders();
        } else {
            showToast(data.error || 'çµå¸³å¤±æ•—');
        }
    } catch (error) {
        console.error('çµå¸³å¤±æ•—:', error);
        showToast('çµå¸³æ™‚ç™¼ç”ŸéŒ¯èª¤');
    }
}

// è¨‚å–®ç›¸é—œå‡½æ•¸
function viewMyOrders() {
    if (!currentUser) {
        showToast('è«‹å…ˆç™»å…¥');
        return;
    }
    switchPage('ordersPage');
}

async function loadOrders() {
    if (!currentUser) {
        showToast('è«‹å…ˆç™»å…¥');
        return;
    }

    try {
        const response = await fetch('/api/orders');
        const data = await response.json();
        
        const ordersHtml = data.orders.map(order => `
            <div class="order-card">
                <h3>è¨‚å–®æ™‚é–“: ${new Date(order.order_time).toLocaleString()}</h3>
                <p>è¨‚å–®ç‹€æ…‹: ${order.status}</p>
                <div class="order-items">
                    ${order.items.map(item => `
                        <div class="order-item">
                            ${item.product_name} x ${item.quantity} = $${item.subtotal}
                        </div>
                    `).join('')}
                </div>
                <p class="order-total">ç¸½é‡‘é¡: $${order.total_price}</p>
            </div>
        `).join('');

        document.getElementById('ordersList').innerHTML = ordersHtml || '<p>å°šç„¡è¨‚å–®è¨˜éŒ„</p>';
    } catch (error) {
        console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
        showToast('è¼‰å…¥è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤');
    }
}

// é é¢åˆ‡æ›å‡½æ•¸
function switchPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(pageId).classList.add('active');

    if (pageId === 'ordersPage') {
        loadOrders();
    }
}

// å·¥å…·å‡½æ•¸
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.remove('hidden');
    
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}
